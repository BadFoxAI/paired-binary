<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paired Binary WASM Test Suite</title>
</head>
<body>

<center>
    <h1><font face="monospace" size="5">Paired Binary WASM Test Suite</font></h1>
</center>

<hr width="80%">

<!-- Section 1: Propagator Setup -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">1. Propagator Setup</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>S_base Values (comma-separated):</b></font></td>
            <td><input type="text" id="sBaseValuesInput" value="0,1,2" size="35"></td>
        </tr>
        <tr>
            <td align="right"><font face="monospace" size="2"><b>N_base Bits:</b></font></td>
            <td><input type="number" id="nBaseBitsInput" value="3" min="1"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="setupWasmPropagator()"><font face="monospace" size="2">Initialize/Update Propagator</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Section 2: Paired Entity Creation -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">2. Create Paired Entity</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>X Value (decimal string):</b></font></td>
            <td><input type="text" id="peXValueInput" value="2" size="30"></td>
        </tr>
        <tr>
            <td align="right"><font face="monospace" size="2"><b>N-bits:</b></font></td>
            <td><input type="number" id="peNBitsInput" value="3" min="1"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="runCreatePairedEntity()"><font face="monospace" size="2">Create Paired Entity</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Section 3: Membership Test -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">3. Test S_N Membership</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>X Value (decimal string):</b></font></td>
            <td><input type="text" id="memberXValueInput" value="18" size="30"></td>
        </tr>
        <tr>
            <td align="right"><font face="monospace" size="2"><b>Target N-bits:</b></font></td>
            <td><input type="number" id="memberNBitsInput" value="6" min="1"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="runIsMember()"><font face="monospace" size="2">Test Membership</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Section 4: Decomposition -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">4. Decompose to S_base</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>X Value (decimal string):</b></font></td>
            <td><input type="text" id="decomposeXValueInput" value="18" size="30"></td>
        </tr>
        <tr>
            <td align="right"><font face="monospace" size="2"><b>Target N-bits:</b></font></td>
            <td><input type="number" id="decomposeNBitsInput" value="6" min="1"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="runDecompose()"><font face="monospace" size="2">Decompose</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Section 5: Composition -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">5. Compose from S_base</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>S_base Components (comma-separated):</b></font></td>
            <td><input type="text" id="composeComponentsInput" value="2,2" size="35"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="runCompose()"><font face="monospace" size="2">Compose</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Section 6: Random Member Generation -->
<table border="1" width="80%" align="center" cellpadding="3" cellspacing="0">
    <thead>
        <tr>
            <th colspan="2" bgcolor="#E0E0E0">
                <font face="monospace" size="3">6. Generate Random S_N Member</font>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td align="right" width="40%"><font face="monospace" size="2"><b>Target N-bits:</b></font></td>
            <td><input type="number" id="randomNBitsInput" value="6" min="1"></td>
        </tr>
        <tr>
            <td align="right"><font face="monospace" size="2"><b>Seed Offset (for PRNG):</b></font></td>
            <td><input type="number" id="randomSeedOffsetInput" value="0"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <button onclick="runGenerateRandom()"><font face="monospace" size="2">Generate Random</font></button>
            </td>
        </tr>
    </tbody>
</table>

<hr width="80%">

<!-- Output Area -->
<center>
    <h3><font face="monospace" size="4">Results / Log</font></h3>
    <textarea id="outputLog" rows="15" cols="90" readonly="readonly" style="font-family: monospace;"></textarea>
</center>

<script type="module">
    // Adjust path to your WASM package's JS file
    import init, { 
        setup_propagator, 
        is_member, 
        decompose_to_base, 
        compose_from_base,
        generate_random_member,
        create_paired_entity 
    } from './pkg/paired_binary.js'; // Ensure 'paired_binary' matches your crate name in Cargo.toml

    const outputLog = document.getElementById('outputLog');
    let wasmInitialized = false;

    function log(message) {
        console.log(message);
        const currentLog = outputLog.value;
        // Keep only a certain amount of log to prevent browser slowdown
        const maxLogLength = 10000; 
        const newMessage = `${new Date().toLocaleTimeString()}: ${JSON.stringify(message, null, 2)}\n\n`;
        outputLog.value = (currentLog + newMessage).slice(-maxLogLength);
        outputLog.scrollTop = outputLog.scrollHeight; 
    }

    function logError(context, error) {
        console.error(context, error);
        let errorString;
        if (typeof error === 'string') {
            errorString = error;
        } else if (error && typeof error.message === 'string') { 
            errorString = error.message;
        } else if (error && typeof error.toString === 'function') {
            errorString = error.toString();
        } else {
            errorString = JSON.stringify(error);
        }
        const currentLog = outputLog.value;
        const maxLogLength = 10000;
        const newErrorMessage = `${new Date().toLocaleTimeString()}: ERROR [${context}]: ${errorString}\n\n`;
        outputLog.value = (currentLog + newErrorMessage).slice(-maxLogLength);
        outputLog.scrollTop = outputLog.scrollHeight;
    }

    async function initializeWasm() {
        if (wasmInitialized) return true;
        try {
            await init();
            log("WASM module initialized successfully.");
            wasmInitialized = true;
            setupWasmPropagator(); 
            return true;
        } catch (e) {
            logError("WASM Initialization Failed", e);
            wasmInitialized = false;
            return false;
        }
    }

    window.setupWasmPropagator = async () => {
        if (!await initializeWasm()) return;
        const sBaseValuesStr = document.getElementById('sBaseValuesInput').value;
        const nBaseBits = parseInt(document.getElementById('nBaseBitsInput').value);
        try {
            setup_propagator(sBaseValuesStr, nBaseBits);
            log(`Propagator initialized/updated: S_base_values='${sBaseValuesStr}', N_base_bits=${nBaseBits}`);
        } catch (e) {
            logError("Setup Propagator", e);
        }
    };

    window.runCreatePairedEntity = async () => {
        if (!await initializeWasm()) return;
        const xValStr = document.getElementById('peXValueInput').value;
        const nBits = parseInt(document.getElementById('peNBitsInput').value);
        try {
            const result = create_paired_entity(xValStr, nBits);
            log({ action: "CreatePairedEntity", inputs: { x: xValStr, n: nBits }, result: result });
        } catch (e) {
            logError("CreatePairedEntity", e);
        }
    };

    window.runIsMember = async () => {
        if (!await initializeWasm()) return;
        const xValStr = document.getElementById('memberXValueInput').value;
        const nBits = parseInt(document.getElementById('memberNBitsInput').value);
        try {
            const result = is_member(xValStr, nBits);
            log({ action: "IsMember", inputs: { x: xValStr, n: nBits }, result: result });
        } catch (e) {
            logError("IsMember", e);
        }
    };

    window.runDecompose = async () => {
        if (!await initializeWasm()) return;
        const xValStr = document.getElementById('decomposeXValueInput').value;
        const nBits = parseInt(document.getElementById('decomposeNBitsInput').value);
        try {
            const wasm_result_array = decompose_to_base(xValStr, nBits); // This is a js_sys::Array
            
            // Convert js_sys::Array to a native JavaScript array of strings
            const components = [];
            // js_sys::Array can be iterated using for...of if wasm-bindgen features are right,
            // or by manually getting length and using get(i).
            // Array.from also works robustly.
            const nativeJsArray = Array.from(wasm_result_array); // Converts iterable to native JS array
            for (const jsVal of nativeJsArray) {
                 // Each element in nativeJsArray is a JsValue (likely string)
                 if (typeof jsVal === 'string') { // If already a JS string
                    components.push(jsVal);
                 } else if (jsVal && typeof jsVal.as_string === 'function') { // If a JsValue object with as_string()
                    components.push(jsVal.as_string());
                 } else {
                    components.push(String(jsVal)); // Fallback
                 }
            }
            log({ action: "Decompose", inputs: { x: xValStr, n: nBits }, result: components });
        } catch (e) {
            logError("Decompose", e);
        }
    };

    window.runCompose = async () => {
        if (!await initializeWasm()) return;
        const componentsStr = document.getElementById('composeComponentsInput').value;
        const componentsArr = componentsStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
        
        const js_array_for_wasm = js_sys.Array.new_with_length(componentsArr.length);
        for (let i = 0; i < componentsArr.length; i++) {
            // wasm_bindgen will convert native JS strings to JsValue strings automatically here.
            js_array_for_wasm.set(i, componentsArr[i]); 
        }
        try {
            const result = compose_from_base(js_array_for_wasm);
            log({ action: "Compose", inputs: { components: componentsArr }, result: result });
        } catch (e) {
            logError("Compose", e);
        }
    };

    window.runGenerateRandom = async () => {
        if (!await initializeWasm()) return;
        const nBits = parseInt(document.getElementById('randomNBitsInput').value);
        const seedOffset = parseInt(document.getElementById('randomSeedOffsetInput').value);
        try {
            const result = generate_random_member(nBits, seedOffset);
            log({ action: "GenerateRandom", inputs: { n: nBits, seedOffset: seedOffset }, result: result });
        } catch (e) {
            logError("GenerateRandom", e);
        }
    };

    initializeWasm();

</script>

</body>
</html>
