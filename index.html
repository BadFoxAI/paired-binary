<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paired Binary Interactive Explorer</title>
    <style>
        /* ... (Keep all the great CSS from the previous version) ... */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px; background-color: #f0f4f8; /* Slightly cooler background */
            color: #333; line-height: 1.6; display: flex; flex-direction: column; align-items: center;
        }
        .main-container {
            width: 100%; max-width: 960px; background-color: #fff;
            padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #dee2e6;
        }
        h1, h2, h3 { color: #1a237e; /* Indigo */ text-align: center; }
        h1 { font-size: 2.4em; margin-bottom: 15px; font-weight: 600;}
        h2 { font-size: 1.75em; margin-top: 35px; margin-bottom: 20px; border-bottom: 2px solid #3f51b5; padding-bottom: 8px; font-weight: 600;}
        h3 { margin-top: 25px; margin-bottom: 15px; text-align:left; font-size: 1.3em; color: #3f51b5; font-weight: 600;}

        .status-panel { text-align: center; margin-bottom: 25px; padding: 12px; border-radius: 6px; font-weight: 500; border: 1px solid transparent; }
        .status-ok { background-color: #d1e7dd; /* Light Green */ color: #0f5132; border-color: #a3cfbb;}
        .status-error { background-color: #f8d7da; /* Light Red */ color: #842029; border-color: #f5c2c7;}
        .status-info { background-color: #cff4fc; /* Light Blue */ color: #055160; border-color: #9eeaf9;}

        .primary-visualization, .key-benchmark, .advanced-section {
            padding: 20px; margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px; background-color: #fcfdff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .primary-visualization p, .key-benchmark p { text-align: center; margin-bottom: 18px; color: #6c757d; font-size: 0.95em;}
        
        #coordinatePlotSvgContainer { text-align: center; }
        #coordinatePlotSvg { border: 1px solid #ced4da; background-color: var(--surface-color); border-radius: 4px;}

        button {
            background-color: #3f51b5; /* Indigo */ color: white;
            padding: 12px 22px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 1em; font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: inline-block; margin: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #303f9f; transform: translateY(-1px); }
        button:active { background-color: #283593; transform: translateY(0px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: translateY(0); }
        button.secondary-action { background-color: #78909c; /* Blue Grey */ }
        button.secondary-action:hover { background-color: #607d8b; }
        button.test-suite-button { background-color: #2ecc71; } /* Green Accent */
        button.test-suite-button:hover { background-color: #27ae60; }


        details {
            background-color: #f8f9fa; border: 1px solid #dee2e6;
            border-radius: 6px; margin-top: 30px;
        }
        summary {
            font-weight: 600; font-size: 1.25em; color: #343a40;
            padding: 15px 20px; cursor: pointer; background-color: #e9ecef;
            border-radius: 6px; transition: background-color 0.2s ease;
            list-style-position: inside; 
        }
        details[open] summary { border-bottom: 1px solid #dee2e6; border-radius: 6px 6px 0 0;}
        summary:hover { background-color: #ced4da; }
        .details-content { padding: 25px; background-color: var(--surface-color); border-radius: 0 0 6px 6px;}

        .control-group { margin-bottom: 18px; padding: 12px; border-radius: 5px; background-color: #fdfdff; border: 1px solid #f0f0f0;}
        .control-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #495057; font-size: 0.95em; }
        .control-group input[type="text"],
        .control-group input[type="number"],
        .control-group select {
            width: calc(100% - 24px); padding: 10px; margin-bottom: 10px;
            border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1em;
            background-color: #f8f9fa;
        }
        .control-group input[type="text"]:focus,
        .control-group input[type="number"]:focus,
        .control-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(63, 81, 181, 0.25);
            outline: none;
        }
        .control-group button { width: auto; font-size: 0.95em; padding: 8px 18px; }

        #mainOutputArea, #benchmarkResultArea {
            margin-top: 18px; padding: 15px; border: 1px solid #ced4da; border-radius: 5px;
            background-color: #eef2f7; min-height: 45px; font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap; font-size: 0.95em; overflow-wrap: break-word;
        }
        #fullLogContainer { margin-top: 30px;}
        #fullOutputLog { display:none; width: 100%; height: 300px; font-family: 'Courier New', Courier, monospace; font-size: 0.85em; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; box-sizing: border-box; background-color: #f8f9fa; white-space: pre-wrap; overflow-y: auto; margin-top: 10px;}
        .log-controls { margin-bottom: 10px; text-align: center; }
        .log-controls button { margin: 5px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Paired Binary Interactive Explorer</h1>
        <div id="wasmStatus" class="status-panel status-info">Loading WASM...</div>
        <div id="mainOutputArea"><p><i>Status and results of primary actions will appear here.</i></p></div>

        <section class="primary-visualization">
            <h2>S<sub>2*N<sub>base</sub></sub> Coordinate Plot</h2>
            <p>Visualizes members of S<sub>2*N<sub>base</sub></sub> using currently configured S_base values as coordinates. 
               (X_S<sub>2N</sub> = (H_upper_S<sub>base</sub>, H_lower_S<sub>base</sub>)). Click button below to draw/redraw.</p>
            <div style="text-align:center;">
                 <button onclick="drawCoordinatePlotSVG()" id="drawCoordinatePlotButton">Draw S<sub>2*N<sub>base</sub></sub> Plot</button>
            </div>
            <div id="coordinatePlotSvgContainer" style="margin-top:15px;">
                <svg id="coordinatePlotSvg" width="400" height="400" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </section>

        <section class="key-benchmark">
             <!-- ... Key Benchmark section same as before ... -->
            <h2>Key Performance Metric</h2>
            <p>Test how large 'N' can be for `generate_random_member` + `is_member` to complete within a target time.
               (This test temporarily sets S_base to {0,1,2}, N_base=3 for consistency.)</p>
            <label for="depthTestTimeLimit">Time Limit per N (ms):</label>
            <input type="number" id="depthTestTimeLimit" value="500" style="width:100px; display:inline-block; margin-right:10px;">
            <button onclick="runDepthTest()" id="depthTestButton">Run Max N Depth Test</button>
            <div id="benchmarkResultArea" style="margin-top:15px;"><p><i>Depth test results will appear here.</i></p></div>
        </section>

        <details id="advancedControlsDetails">
            <summary>Advanced Controls & Detailed Tests Â»</summary>
            <div class="details-content">
                <h2>Propagator Setup</h2>
                <div class="control-group">
                    <label for="sBaseValuesInput">S_base Values (comma-separated decimal strings):</label>
                    <input type="text" id="sBaseValuesInput" value="0,1,2">
                    <label for="nBaseBitsInput">N_base Bits:</label>
                    <input type="number" id="nBaseBitsInput" value="3" min="1">
                    <button onclick="setupWasmPropagator()">Initialize / Update Propagator</button>
                </div>
                <!-- ... Other advanced sections (Automated Tests, Perf Tests, Manual Func Tests) same as before ... -->
                <h2>Automated Basic Tests</h2>
                <div class="control-group">
                    <button class="test-suite-button" onclick="runAutomatedTests()">Run Basic Logic Test Suite</button>
                </div>
                
                <h2>Performance Tests (Manual)</h2>
                <div class="control-group">
                    <h3>Run Speed Test</h3>
                    <label for="perfTestFunction">Function to Test:</label>
                    <select id="perfTestFunction">
                        <option value="is_member">is_member</option>
                        <option value="decompose_to_base">decompose_to_base</option>
                        <option value="compose_from_base">compose_from_base</option>
                        <option value="generate_random_member">generate_random_member</option>
                        <option value="create_paired_entity">create_paired_entity</option>
                    </select>
                    <label for="perfTestNValue">Target N-bits:</label>
                    <input type="number" id="perfTestNValue" value="12">
                     <label for="perfTestXValue">X Value for test (if applicable):</label>
                    <input type="text" id="perfTestXValue" value="0">
                    <label for="perfTestIterations">Number of Iterations:</label>
                    <input type="number" id="perfTestIterations" value="1000">
                    <button onclick="runPerformanceTest()">Start Manual Perf Test</button>
                </div>

                <h2>Manual Function Tests</h2>
                <div class="control-group"> /* ... PE ... */ </div>
                <div class="control-group"> /* ... IsMember ... */ </div>
                <!-- Add other manual test groups here if you had them separated -->
            </div>
        </details>

        <div id="fullLogContainer">
             <!-- ... Verbose Log section same as before ... -->
            <h2>Verbose Log</h2>
            <div class="log-controls">
                <button onclick="toggleFullLog()" class="secondary-action">Toggle Full Log Display</button>
                <button onclick="exportFullLog()" class="secondary-action">Export Full Log</button>
                <button onclick="clearFullLog()" class="secondary-action">Clear Full Log</button>
            </div>
            <textarea id="fullOutputLog" readonly></textarea>
        </div>
    </div>

    <script type="module">
        import init, { 
            setup_propagator, 
            is_member, 
            decompose_to_base, 
            compose_from_base,
            generate_random_member,
            create_paired_entity 
        } from './pkg/paired_binary.js';

        // ... (All JS variables like mainOutputArea, verboseLog, wasmInitialized, etc. same as before) ...
        const mainOutputArea = document.getElementById('mainOutputArea');
        const benchmarkResultArea = document.getElementById('benchmarkResultArea');
        const fullOutputLog = document.getElementById('fullOutputLog');
        const wasmStatusDiv = document.getElementById('wasmStatus');
        const coordinatePlotSvgElement = document.getElementById('coordinatePlotSvg'); // Changed from s6SvgElement
        const SVG_NS = "http://www.w3.org/2000/svg";

        let wasmInitialized = false;
        let currentSBaseForDisplay = "0,1,2"; 
        let currentNBaseForDisplay = 3;
        let isBenchmarking = false;


        function displayMain(message, type = "info") { /* ... same ... */ }
        function verboseLog(message, context = "Generic") { /* ... same ... */ }
        async function initializeWasm() { /* ... same ... */ }
        window.setupWasmPropagator = async (doLog = true) => { /* ... same ... */ };
        
        async function runWasmOpForDisplay(actionName, operationFunc, ...args) { /* ... same ... */ }
        window.runCreatePairedEntity = () => { /* ... same ... */ };
        window.runIsMember = () => {  /* ... same ... */ };
        window.runDecompose = async () => { /* ... same ... */ };
        window.runCompose = () => { /* ... same ... */ };
        window.runGenerateRandom = () => { /* ... same ... */ };
        window.runAutomatedTests = async () => { /* ... same ... */ };
        window.runDepthTest = async () => { /* ... same ... */ };
        window.runPerformanceTest = async () => { /* ... same, ensure displayMain and verboseLog are used ... */};


        // --- NEW/MODIFIED: S_2N_base Coordinate Plot SVG ---
        window.drawCoordinatePlotSVG = async () => {
            if (!await initializeWasm()) return;

            const sBaseValuesStr = document.getElementById('sBaseValuesInput').value;
            const nBaseBits = parseInt(document.getElementById('nBaseBitsInput').value);

            // Update propagator to current settings if they differ from what was used last for display
            if (currentSBaseForDisplay !== sBaseValuesStr || currentNBaseForDisplay !== nBaseBits) {
                verboseLog(`Updating propagator for coordinate plot: S_base='${sBaseValuesStr}', N_base=${nBaseBits}`, "CoordPlot-Setup");
                try {
                    setup_propagator(sBaseValuesStr, nBaseBits);
                    currentSBaseForDisplay = sBaseValuesStr;
                    currentNBaseForDisplay = nBaseBits;
                } catch (e) {
                    const errorStr = (e instanceof Error) ? `${e.name}: ${e.message}` : String(e);
                    displayMain(`Coordinate Plot Error: Could not set propagator - ${errorStr}`, "error");
                    verboseLog(`Failed to set propagator for Coordinate Plot: ${errorStr}`, "CoordPlot-Setup"); 
                    return;
                }
            }
            
            coordinatePlotSvgElement.innerHTML = ''; // Clear previous SVG content
            
            const sBaseParsedValues = currentSBaseForDisplay.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));

            if (sBaseParsedValues.length === 0) {
                displayMain("Coordinate Plot Error: S_base values are not valid numbers or are empty.", "error");
                verboseLog("S_base values could not be parsed into numbers for plotting.", "CoordPlot");
                return;
            }
            // Sort for consistent axis ordering
            sBaseParsedValues.sort((a, b) => a - b); 
            const uniqueSBaseValues = [...new Set(sBaseParsedValues)]; // Ensure unique for axes

            const plotMembers = []; 

            for (const h_upper of uniqueSBaseValues) {
                for (const h_lower of uniqueSBaseValues) {
                    try {
                        // compose_from_base expects an array of strings
                        const composedResult = compose_from_base([String(h_upper), String(h_lower)]);
                        if (composedResult && typeof composedResult.value === 'string' && 
                            typeof composedResult.n_bits === 'number' && composedResult.n_bits === currentNBaseForDisplay * 2) {
                             plotMembers.push({ 
                                 x_val_composed: parseInt(composedResult.value), 
                                 h_upper: h_upper, 
                                 h_lower: h_lower 
                             });
                        } else {
                            verboseLog(`Unexpected compose result for (${h_upper},${h_lower}): ${JSON.stringify(composedResult)}`, "CoordPlot-Compose");
                        }
                    } catch (e) {
                        verboseLog(`Error composing S_${currentNBaseForDisplay*2} member for (${h_upper},${h_lower}): ${e}`, "CoordPlot-Compose");
                    }
                }
            }

            if (plotMembers.length === 0) {
                displayMain("Coordinate Plot: No members generated or S_base does not form valid pairs.", "info");
                verboseLog(`No S_${currentNBaseForDisplay*2} members generated for plotting. Check S_base.`, "CoordPlot");
                return;
            }

            const svgWidth = parseInt(coordinatePlotSvgElement.getAttribute('width'));
            const svgHeight = parseInt(coordinatePlotSvgElement.getAttribute('height'));
            
            const minCoord = Math.min(...uniqueSBaseValues);
            const maxCoord = Math.max(...uniqueSBaseValues);
            const coordRange = (maxCoord - minCoord) || 1; // Avoid division by zero if all S_base values are same
            const numTicks = uniqueSBaseValues.length;

            const padding = 50; // Increased padding for labels
            const plotWidth = svgWidth - 2 * padding;
            const plotHeight = svgHeight - 2 * padding;

            const xScale = plotWidth / coordRange;
            const yScale = plotHeight / coordRange;
            const radius = Math.min(8, plotWidth / numTicks / 3, plotHeight / numTicks / 3); 

            verboseLog(`Plotting ${plotMembers.length} S_${currentNBaseForDisplay*2} members using SVG. MinCoord: ${minCoord}, MaxCoord: ${maxCoord}, Range: ${coordRange}`, "CoordPlot");

            // Create a group for easier translation
            const group = document.createElementNS(SVG_NS, 'g');
            group.setAttribute('transform', `translate(${padding}, ${padding})`);
            coordinatePlotSvgElement.appendChild(group);

            // Draw Axes and Labels
            // X-axis
            let lineX = document.createElementNS(SVG_NS, 'line');
            lineX.setAttribute('x1', 0); lineX.setAttribute('y1', plotHeight);
            lineX.setAttribute('x2', plotWidth); lineX.setAttribute('y2', plotHeight);
            lineX.setAttribute('stroke', '#888'); lineX.setAttribute('stroke-width', '1');
            group.appendChild(lineX);
            // Y-axis
            let lineY = document.createElementNS(SVG_NS, 'line');
            lineY.setAttribute('x1', 0); lineY.setAttribute('y1', 0);
            lineY.setAttribute('x2', 0); lineY.setAttribute('y2', plotHeight);
            lineY.setAttribute('stroke', '#888'); lineY.setAttribute('stroke-width', '1');
            group.appendChild(lineY);

            uniqueSBaseValues.forEach(val => {
                const xTickPos = (val - minCoord) * xScale;
                const yTickPos = plotHeight - (val - minCoord) * yScale; // Y inverted

                // X tick labels
                let xLabel = document.createElementNS(SVG_NS, 'text');
                xLabel.setAttribute('x', xTickPos); xLabel.setAttribute('y', plotHeight + 15);
                xLabel.setAttribute('font-size', '10px'); xLabel.setAttribute('fill', '#555');
                xLabel.setAttribute('text-anchor', 'middle'); xLabel.textContent = String(val);
                group.appendChild(xLabel);
                // Y tick labels
                let yLabel = document.createElementNS(SVG_NS, 'text');
                yLabel.setAttribute('x', -10); yLabel.setAttribute('y', yTickPos);
                yLabel.setAttribute('font-size', '10px'); yLabel.setAttribute('fill', '#555');
                yLabel.setAttribute('text-anchor', 'end'); yLabel.setAttribute('alignment-baseline', 'middle');
                yLabel.textContent = String(val);
                group.appendChild(yLabel);
            });


            plotMembers.forEach(member => {
                // Map h_upper, h_lower to plot coordinates
                // (val - minCoord) normalizes, then scale, then y is inverted
                const plotX = (member.h_upper - minCoord) * xScale;
                const plotY = plotHeight - ((member.h_lower - minCoord) * yScale); 

                const circle = document.createElementNS(SVG_NS, 'circle');
                circle.setAttribute('cx', plotX); circle.setAttribute('cy', plotY);
                circle.setAttribute('r', radius);
                
                // Simple coloring based on composed value parity or magnitude
                let fillColor = (member.x_val_composed % 2 === 0) ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 159, 64, 0.7)';
                circle.setAttribute('fill', fillColor);
                circle.setAttribute('stroke', '#555');
                circle.setAttribute('stroke-width', '1');
                group.appendChild(circle);

                const text = document.createElementNS(SVG_NS, 'text');
                text.setAttribute('x', plotX); text.setAttribute('y', plotY);
                text.setAttribute('dy', '.3em'); 
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '9px');
                text.setAttribute('fill', '#000');
                text.textContent = String(member.x_val_composed);
                group.appendChild(text);
            });
             displayMain("Coordinate Plot", `Plotted ${plotMembers.length} S_${currentNBaseForDisplay*2} members.`, "ok");
        };
        
        window.toggleFullLog = () => { /* ... same ... */ };
        window.exportFullLog = () => { /* ... same ... */ };
        window.clearFullLog = () => { /* ... same ... */ };

        initializeWasm();
    </script>
</body>
</html>
